name: build-and-rollout-api-mobile-app

on:
  push:
    branches:
      - prod

permissions:
  id-token: write
  contents: read

env:
  REPO: api-mobile-app
  AWS_REGION: ${{ secrets.AWS_REGION }}
  REGISTRY: ${{ secrets.USER }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com

jobs:
  build-push:
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: arn:aws:iam::${{ secrets.USER }}:role/edge-proxy

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - id: build
        name: Build and push Docker image
        run: |
          TAG=${{ github.sha }}
          IMAGE=$REGISTRY/$REPO:$TAG
          docker build -t "$IMAGE" .
          docker push  "$IMAGE"
          docker tag   "$IMAGE" "$REGISTRY/$REPO:latest"
          docker push  "$REGISTRY/$REPO:latest"
          echo "image=$IMAGE" >> "$GITHUB_OUTPUT"

    outputs:
      image: ${{ steps.build.outputs.image }}

  rollout:
    needs: build-push
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: arn:aws:iam::${{ secrets.USER }}:role/edge-proxy

      - name: Rollout to EC2s tagged app=api-mobile-app
        env:
          IMAGE: ${{ needs.build-push.outputs.image }}
          REGION: ${{ env.AWS_REGION }}
          REGISTRY: ${{ env.REGISTRY }}
        run: |
          echo "Rolling out new image to EC2s tagged app=api-mobile-app"

          aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy api-mobile-app rollout" \
            --targets '[{ "Key": "tag:app", "Values": ["api-mobile-app"] }]' \
            --parameters "commands=[
              \"bash -c 'set -euo pipefail;

              echo \\\"### Starting rollout for api-mobile-app ###\\\"
              echo \\\"Using image: $IMAGE\\\"

              # Ensure git is installed
              if ! command -v git >/dev/null 2>&1; then
                echo \\\"Git not found — installing...\\\"
                apt-get update && apt-get install -y git
              fi

              # Ensure /opt/app exists and repo synced
              if [ ! -d /opt/app ]; then
                echo \\\"App directory not found — cloning repo...\\\"
                mkdir -p /opt
                cd /opt
                git clone https://github.com/Manny2becerra/api.mobile.app.aceclub.app.git app
              else
                echo \\\"App directory exists — updating...\\\"
                cd /opt/app
                git fetch --all && git reset --hard origin/prod || true
              fi

              # Ensure AWS CLI installed for root
              if ! command -v aws >/dev/null 2>&1; then
                echo \\\"AWS CLI not found — installing...\\\"
                apt-get update -y
                apt-get install -y unzip curl
                curl -s \\\"https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip\\\" -o awscliv2.zip
                unzip -q awscliv2.zip
                ./aws/install
                rm -rf awscliv2.zip aws
                export PATH=/usr/local/bin:$PATH
              fi

              # Login to ECR (non-interactive)
              export PATH=/usr/local/bin:$PATH
              aws ecr get-login-password --region $REGION | docker login -u AWS --password-stdin $REGISTRY

              echo \\\"Fetching environment variables via fetch-env.sh...\\\"
              chmod +x /opt/app/fetch-env.sh
              cd /opt/app
              ./fetch-env.sh prod

              echo \\\"Pulling latest images...\\\"
              docker compose pull api-mobile-app

              echo \\\"Rebuilding and restarting services...\\\"
              docker compose up -d --build --remove-orphans

              echo \\\"Cleaning up unused images...\\\"
              docker image prune -f

              echo \\\"✅ Deployment complete for api-mobile-app\\\"
              '\"
            ]" \
            --region $REGION

